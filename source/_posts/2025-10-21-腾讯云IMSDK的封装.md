---
title: è…¾è®¯äº‘IMSDKçš„å°è£…
author: é«˜çº¢ç¿”
date: 2025-10-21 10:16:08
categories: å‰ç«¯æ¶æ„
tags: SDK
---

[MODE: RESEARCH]

å¿«ä¹ç¨‹åºå‘˜ï¼Œæˆ‘æ¥è¯¦ç»†è®²è§£ `useIMManager.ts` ä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼è¿™ä¸ªæ–‡ä»¶æ˜¯è…¾è®¯äº‘IM SDKçš„å°è£…ï¼Œæä¾›äº†å®Œæ•´çš„å³æ—¶é€šè®¯åŠŸèƒ½ã€‚

## ğŸ—ï¸ **æ•´ä½“æ¶æ„è®¾è®¡**

### **1. å•ä¾‹æ¨¡å¼è®¾è®¡**
```typescript
export class IMManager {
    private static chatInstance: IMManager
    
    public static getInstance(): IMManager {
        if (!this.chatInstance) {
            this.chatInstance = new IMManager()
        }
        return this.chatInstance
    }
}
```
- **è®¾è®¡ç›®çš„**: ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªIMå®ä¾‹ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- **ä¼˜åŠ¿**: èŠ‚çœå†…å­˜ï¼Œç»Ÿä¸€ç®¡ç†è¿æ¥çŠ¶æ€
- **ä½¿ç”¨åœºæ™¯**: å¤šç»„ä»¶å…±äº«åŒä¸€ä¸ªIMè¿æ¥

### **2. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ**
```typescript
export interface IMState {
    connectionState: ConnectionState    // è¿æ¥çŠ¶æ€
    networkState: NetworkState        // ç½‘ç»œçŠ¶æ€
    isReady: boolean                  // SDKæ˜¯å¦å°±ç»ª
    isLoggedIn: boolean              // æ˜¯å¦å·²ç™»å½•
    errorCount: number               // é”™è¯¯è®¡æ•°
    reconnectAttempts: number         // é‡è¿æ¬¡æ•°
    lastHeartbeat: number            // æœ€åå¿ƒè·³æ—¶é—´
    timestamp: number                // çŠ¶æ€æ›´æ–°æ—¶é—´
}
```

## ğŸ”§ **æ ¸å¿ƒæ–¹æ³•è¯¦è§£**

### **1. åˆå§‹åŒ–ä¸è¿æ¥ç®¡ç†**

#### **æ„é€ å‡½æ•° - ç³»ç»Ÿåˆå§‹åŒ–**
```typescript
constructor() {
    try {
        // åˆ›å»ºè…¾è®¯äº‘IMå®ä¾‹
        this.chat = TencentCloudChat.create({ 
            SDKAppID, 
            unlimitedAVChatRoom: true 
        })
        
        // è®¾ç½®æ—¥å¿—çº§åˆ«
        this.chat.setLogLevel(0)
        
        // æ³¨å†Œä¸Šä¼ æ’ä»¶
        this.chat.registerPlugin({ 'tim-upload-plugin': TIMUploadPlugin })
        
        // åˆå§‹åŒ–çŠ¶æ€
        this.state = this.createInitialState()
        
        // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
        this.registerEventListeners()
        
        // å¯åŠ¨å¥åº·æ£€æŸ¥
        this.startHealthCheck()
    } catch (error) {
        throw new IMError('IM SDK åˆå§‹åŒ–å¤±è´¥', 'INIT_FAILED', error)
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- ğŸ¯ **SDKåˆå§‹åŒ–**: åˆ›å»ºè…¾è®¯äº‘IMå®ä¾‹
- ğŸ”§ **æ’ä»¶æ³¨å†Œ**: æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- ğŸ“Š **çŠ¶æ€åˆå§‹åŒ–**: è®¾ç½®åˆå§‹çŠ¶æ€
- ğŸ‘‚ **äº‹ä»¶ç›‘å¬**: æ³¨å†Œæ‰€æœ‰å¿…è¦çš„äº‹ä»¶å¤„ç†å™¨
- â¤ï¸ **å¥åº·æ£€æŸ¥**: å¯åŠ¨å¿ƒè·³å’Œå¥åº·ç›‘æ§

#### **äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ**
```typescript
private registerEventListeners(): void {
    // åŸºç¡€æ¶ˆæ¯äº‹ä»¶
    this.chat.on(TencentCloudChat.EVENT.MESSAGE_RECEIVED, this.handleMessageReceived.bind(this))
    this.chat.on(TencentCloudChat.EVENT.SDK_READY, this.handleSDKReady.bind(this))
    this.chat.on(TencentCloudChat.EVENT.MESSAGE_REVOKED, (revokedMessage: MessageRevokedEvent) => {
        this.emitter.emit(IMEventType.MSG_REVOKED, revokedMessage.data)
    })
    
    // ç½‘ç»œçŠ¶æ€ç›‘æ§
    this.chat.on(TencentCloudChat.EVENT.NET_STATE_CHANGE, this.handleNetworkStateChanged.bind(this))
    
    // é”™è¯¯äº‹ä»¶ç›‘æ§
    this.chat.on(TencentCloudChat.EVENT.ERROR, this.handleError.bind(this))
    this.chat.on(TencentCloudChat.EVENT.KICKED_OUT, this.handleKickedOut.bind(this))
    
    // ç¾¤ç»„ç›¸å…³äº‹ä»¶
    this.chat.on(TencentCloudChat.EVENT.GROUP_ATTRIBUTES_UPDATED, this.handleGroupAttributesUpdated.bind(this))
}
```

### **2. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**

#### **ç™»å½•æ–¹æ³• - ç”¨æˆ·èº«ä»½éªŒè¯**
```typescript
async login(userID: string, userSig: string): Promise<void> {
    try {
        // å‚æ•°éªŒè¯
        this.validateNotEmpty(userID)
        this.validateNotEmpty(userSig)
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (this.isUserLoggedIn) {
            console.log(LOG_PRIFIX, 'IM å·²ç»ç™»å½•')
            return
        }
        
        // æ‰§è¡Œç™»å½•
        await this.chat.login({ userID, userSig })
        
        // æ›´æ–°çŠ¶æ€
        this.isUserLoggedIn = true
        this.currentUserID = userID
        
        this.updateState({
            isLoggedIn: true,
        })
        
        console.log(LOG_PRIFIX, 'IM ç™»å½•æˆåŠŸ')
    } catch (error) {
        // é”™è¯¯å¤„ç†
        this.isUserLoggedIn = false
        this.currentUserID = null
        
        this.updateState({
            isLoggedIn: false,
        })
        
        // å¤„ç†è…¾è®¯äº‘IMçš„é”™è¯¯ç 
        if (error && typeof error === 'object' && 'code' in error) {
            const errorCode = (error as any).code
            let message = 'ç™»å½•å¤±è´¥'
            
            switch (errorCode) {
                case 7001: message = 'ç”¨æˆ·ç­¾åé”™è¯¯'; break
                case 7002: message = 'ç”¨æˆ·IDæ ¼å¼é”™è¯¯'; break
                case 7003: message = 'ç”¨æˆ·å·²ç™»å½•'; break
                case 7004: message = 'ç½‘ç»œè¿æ¥å¤±è´¥'; break
                default: message = `ç™»å½•å¤±è´¥: ${errorCode}`
            }
            
            throw new IMError(message, 'LOGIN_FAILED', error)
        }
        
        throw new IMError('ç™»å½•å¤±è´¥', 'LOGIN_FAILED', error)
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- ğŸ” **èº«ä»½éªŒè¯**: ä½¿ç”¨userIDå’ŒuserSigè¿›è¡Œèº«ä»½éªŒè¯
- ğŸ›¡ï¸ **é‡å¤ç™»å½•æ£€æŸ¥**: é˜²æ­¢é‡å¤ç™»å½•
- ğŸ“Š **çŠ¶æ€æ›´æ–°**: å®æ—¶æ›´æ–°ç™»å½•çŠ¶æ€
- ğŸš¨ **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ç å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

#### **ç™»å‡ºæ–¹æ³• - å®‰å…¨é€€å‡º**
```typescript
async logout(): Promise<void> {
    if (!this.isUserLoggedIn) {
        console.log(LOG_PRIFIX, 'IM æœªç™»å½•ï¼Œæ— éœ€ç™»å‡º')
        return
    }
    
    try {
        // æ¸…ç†å·²åŠ å…¥ç¾¤ç»„
        this.joinedGroups.clear()
        
        // æ‰§è¡Œç™»å‡º
        await this.chat.logout()
        
        // æ›´æ–°çŠ¶æ€
        this.isUserLoggedIn = false
        this.currentUserID = null
        this.connectionState = ConnectionState.DISCONNECTED
        
        this.updateState({
            isLoggedIn: false,
            connectionState: ConnectionState.DISCONNECTED,
        })
        
        console.log(LOG_PRIFIX, 'IM é€€å‡ºæˆåŠŸ')
    } catch (error) {
        // é”™è¯¯å¤„ç†...
        throw new IMError('é€€å‡ºå¤±è´¥', 'LOGOUT_FAILED', error)
    }
}
```

### **3. ç¾¤ç»„ç®¡ç†ç³»ç»Ÿ**

#### **åˆ›å»ºç¾¤ç»„ - å»ºç«‹èŠå¤©å®¤**
```typescript
public async createGroup(groupID: string): Promise<any> {
    try {
        // å‚æ•°éªŒè¯
        this.validateGroupID(groupID)
        this.confirmReady()
        
        // åˆ›å»ºç¾¤ç»„
        const group = await this.chat.createGroup({
            type: TencentCloudChat.TYPES.GRP_AVCHATROOM,  // éŸ³è§†é¢‘èŠå¤©å®¤
            name: groupID,
            isSupportTopic: true,  // æ”¯æŒè¯é¢˜åŠŸèƒ½
            groupID,
        })
        
        console.log(LOG_PRIFIX, 'ç›´æ’­ç¾¤ç»„åˆ›å»ºæˆåŠŸ', group)
        return group
    } catch (error) {
        // é”™è¯¯å¤„ç†
        if (error && typeof error === 'object' && 'code' in error) {
            const errorCode = (error as any).code
            let message = 'åˆ›å»ºç¾¤ç»„å¤±è´¥'
            
            switch (errorCode) {
                case 10013: message = 'ç¾¤ç»„å·²å­˜åœ¨'; break
                case 10014: message = 'ç¾¤ç»„IDæ ¼å¼é”™è¯¯'; break
                case 10015: message = 'ç¾¤ç»„åç§°è¿‡é•¿'; break
                default: message = `åˆ›å»ºç¾¤ç»„å¤±è´¥: ${errorCode}`
            }
            
            throw new IMError(message, 'CREATE_GROUP_FAILED', error)
        }
        
        throw new IMError('åˆ›å»ºç¾¤ç»„å¤±è´¥', 'CREATE_GROUP_FAILED', error)
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- ğŸ—ï¸ **ç¾¤ç»„åˆ›å»º**: åˆ›å»ºéŸ³è§†é¢‘èŠå¤©å®¤
- ğŸ¯ **ç±»å‹é€‰æ‹©**: æ”¯æŒä¸åŒç±»å‹çš„ç¾¤ç»„
- ğŸ”§ **åŠŸèƒ½é…ç½®**: æ”¯æŒè¯é¢˜ã€éŸ³è§†é¢‘ç­‰åŠŸèƒ½
- ğŸš¨ **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ç å¤„ç†

#### **åŠ å…¥ç¾¤ç»„ - å‚ä¸èŠå¤©**
```typescript
public async joinGroup(groupID: string): Promise<any> {
    try {
        // å‚æ•°éªŒè¯
        this.validateGroupID(groupID)
        this.confirmReady()
        
        // æ£€æŸ¥æ˜¯å¦å·²åŠ å…¥
        if (this.joinedGroups.has(groupID)) {
            console.log(LOG_PRIFIX, `å·²åŠ å…¥ç¾¤ç»„ ${groupID}ï¼Œè·³è¿‡é‡å¤åŠ å…¥`)
            return
        }
        
        // åŠ å…¥ç¾¤ç»„
        const result = await this.chat.joinGroup({ 
            groupID, 
            type: TencentCloudChat.TYPES.GRP_AVCHATROOM 
        })
        
        // è®°å½•å·²åŠ å…¥ç¾¤ç»„
        this.joinedGroups.add(groupID)
        
        console.log(LOG_PRIFIX, `å·²åŠ å…¥ç¾¤ç»„ ${groupID}`)
        return result
    } catch (error) {
        // é”™è¯¯å¤„ç†...
        throw new IMError('åŠ å…¥ç¾¤ç»„å¤±è´¥', 'JOIN_GROUP_FAILED', error)
    }
}
```

#### **é€€å‡ºç¾¤ç»„ - ç¦»å¼€èŠå¤©**
```typescript
public async quitGroup(groupID: string): Promise<void> {
    try {
        // å‚æ•°éªŒè¯
        this.validateGroupID(groupID)
        this.confirmReady()
        
        // æ£€æŸ¥æ˜¯å¦å·²åŠ å…¥
        if (!this.joinedGroups.has(groupID)) {
            console.log(LOG_PRIFIX, `æœªåŠ å…¥ç¾¤ç»„ ${groupID}ï¼Œæ— éœ€é€€å‡º`)
            return
        }
        
        // ä»è®°å½•ä¸­ç§»é™¤
        this.joinedGroups.delete(groupID)
        
        // æ‰§è¡Œé€€å‡º
        await this.chat.quitGroup(groupID)
        
        console.log(LOG_PRIFIX, `å·²é€€å‡ºç¾¤ç»„ ${groupID}`)
    } catch (error) {
        throw new IMError('é€€å‡ºç¾¤ç»„å¤±è´¥', 'QUIT_GROUP_FAILED', error)
    }
}
```

### **4. æ¶ˆæ¯ç³»ç»Ÿ**

#### **å‘é€ç¾¤ç»„æ¶ˆæ¯ - ç¾¤èŠåŠŸèƒ½**
```typescript
async sendGroupTextMessage(groupID: string, text: string): Promise<number> {
    try {
        // å‚æ•°éªŒè¯
        this.validateGroupID(groupID)
        this.confirmReady()
        
        if (!text || typeof text !== 'string' || text.trim().length === 0) {
            throw new IMError('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'INVALID_MESSAGE_TEXT', { text })
        }
        
        // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
        const message = this.chat.createTextMessage({
            to: groupID,
            conversationType: TencentCloudChat.TYPES.CONV_GROUP,
            payload: { text },
        })
        
        // å‘é€æ¶ˆæ¯
        await this.chat.sendMessage(message)
        
        console.log(LOG_PRIFIX, `ç¾¤ç»„æ¶ˆæ¯å‘é€æˆåŠŸ: ${groupID}`)
        return 0
    } catch (error) {
        console.error(LOG_PRIFIX, `ç¾¤ç»„æ¶ˆæ¯å‘é€å¤±è´¥: ${groupID}`, error)
        throw new IMError('ç¾¤ç»„æ¶ˆæ¯å‘é€å¤±è´¥', 'SEND_GROUP_MESSAGE_FAILED', error)
    }
}
```

#### **å‘é€ç§èŠæ¶ˆæ¯ - ä¸€å¯¹ä¸€èŠå¤©**
```typescript
async sendPrivateTextMessage(userID: string, text: string): Promise<number> {
    try {
        // å‚æ•°éªŒè¯
        this.validateNotEmpty(userID)
        this.confirmReady()
        
        if (!text || typeof text !== 'string' || text.trim().length === 0) {
            throw new IMError('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'INVALID_MESSAGE_TEXT', { text })
        }
        
        // åˆ›å»ºç§èŠæ¶ˆæ¯
        const message = this.chat.createTextMessage({
            to: userID,
            conversationType: TencentCloudChat.TYPES.CONV_C2C,
            payload: { text },
        })
        
        // å‘é€æ¶ˆæ¯
        await this.chat.sendMessage(message)
        
        console.log(LOG_PRIFIX, `ç§èŠæ¶ˆæ¯å‘é€æˆåŠŸ: ${userID}`)
        return 0
    } catch (error) {
        console.error(LOG_PRIFIX, `ç§èŠæ¶ˆæ¯å‘é€å¤±è´¥: ${userID}`, error)
        throw new IMError('ç§èŠæ¶ˆæ¯å‘é€å¤±è´¥', 'SEND_PRIVATE_MESSAGE_FAILED', error)
    }
}
```

#### **æ¶ˆæ¯æ¥æ”¶å¤„ç† - å®æ—¶æ¶ˆæ¯**
```typescript
private handleMessageReceived(event: { data: Message[] }): void {
    try {
        if (!event || !event.data || !Array.isArray(event.data)) {
            console.warn(LOG_PRIFIX, 'æ”¶åˆ°æ— æ•ˆçš„æ¶ˆæ¯äº‹ä»¶:', event)
            return
        }
        
        console.log('DEBUG_LOG:call handleMessageReceived', event.data)
        
        // å¤„ç†æ¯æ¡æ¶ˆæ¯
        event.data.forEach(message => {
            try {
                const conversationType = message.conversationType
                
                // ç¾¤ç»„æ¶ˆæ¯å¤„ç†
                if (conversationType === TencentCloudChat.TYPES.CONV_GROUP) {
                    // ç¾¤ç»„æ¶ˆæ¯å¤„ç†é€»è¾‘
                }
                
                // è§¦å‘æ¶ˆæ¯æ¥æ”¶äº‹ä»¶
                this.emitter.emit(IMEventType.CHAT_MSG, message)
            } catch (error) {
                console.error(LOG_PRIFIX, 'å¤„ç†å•æ¡æ¶ˆæ¯å¤±è´¥:', error, message)
            }
        })
    } catch (error) {
        console.error(LOG_PRIFIX, 'å¤„ç†æ¶ˆæ¯äº‹ä»¶å¤±è´¥:', error)
    }
}
```

### **5. å†å²æ¶ˆæ¯ç³»ç»Ÿ**

#### **è·å–å†å²æ¶ˆæ¯ - æ¶ˆæ¯è®°å½•**
```typescript
async getHistoryMessages(options: HistoryMessageOptions): Promise<{
    messageList: Message[]
    isCompleted: boolean
    nextReqMessageID?: string
}> {
    try {
        this.confirmReady()
        this.validateConversationID(options.conversationID)
        
        const { conversationID, nextReqMessageID } = options
        
        console.log(LOG_PRIFIX, `å¼€å§‹è·å–å†å²æ¶ˆæ¯: ${conversationID}`, options)
        
        // æ„å»ºè·å–å‚æ•°
        const getMessageListParams: any = {
            conversationID: `${conversationID}`,
        }
        
        // åˆ†é¡µå‚æ•°
        if (nextReqMessageID) {
            getMessageListParams.nextReqMessageID = nextReqMessageID
        }
        
        // è·å–æ¶ˆæ¯åˆ—è¡¨
        const result = await this.chat.getMessageList(getMessageListParams)
        
        console.log(LOG_PRIFIX, `è·å–å†å²æ¶ˆæ¯æˆåŠŸ: ${conversationID}`, {
            messageList: result.data.messageList,
            isCompleted: result.data.isCompleted,
            nextReqMessageID: result.data.nextReqMessageID,
        })
        
        return {
            messageList: result.data.messageList || [],
            isCompleted: result.data.isCompleted,
            nextReqMessageID: result.data.nextReqMessageID,
        }
    } catch (error) {
        console.error(LOG_PRIFIX, `è·å–å†å²æ¶ˆæ¯å¤±è´¥: ${options.conversationID}`, error)
        throw new IMError('è·å–å†å²æ¶ˆæ¯å¤±è´¥', 'GET_HISTORY_MESSAGES_FAILED', error)
    }
}
```

#### **è·å–æœ€è¿‘æ¶ˆæ¯ - æ™ºèƒ½æ¶ˆæ¯è·å–**
```typescript
async getRecentMessages(
    conversationID: string,
    targetCount: number = 50,
    maxRetries: number = 10,
): Promise<Message[]> {
    try {
        this.confirmReady()
        this.validateConversationID(conversationID)
        
        if (targetCount <= 0) {
            throw new IMError('ç›®æ ‡æ¶ˆæ¯æ•°é‡å¿…é¡»å¤§äº0', 'INVALID_TARGET_COUNT', { targetCount })
        }
        
        if (maxRetries < 0) {
            throw new IMError('æœ€å¤§é‡è¯•æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°', 'INVALID_MAX_RETRIES', { maxRetries })
        }
        
        const allMessages: Message[] = []
        let nextReqMessageID: string | undefined
        let retryCount = 0
        
        console.log(LOG_PRIFIX, `å¼€å§‹è·å–æœ€è¿‘ ${targetCount} æ¡æ¶ˆæ¯: ${conversationID}`)
        
        // å¾ªç¯è·å–æ¶ˆæ¯ç›´åˆ°è¾¾åˆ°ç›®æ ‡æ•°é‡
        while (allMessages.length < targetCount) {
            try {
                const result = await this.getHistoryMessages({
                    conversationID,
                    nextReqMessageID,
                })
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°æ¶ˆæ¯ï¼Œé€€å‡ºå¾ªç¯
                if (!result.messageList || result.messageList.length === 0) {
                    console.log(LOG_PRIFIX, `æ²¡æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œåœæ­¢è·å–: ${conversationID}`)
                    break
                }
                
                // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
                allMessages.push(...result.messageList)
                console.log(LOG_PRIFIX, `å·²è·å– ${allMessages.length} æ¡æ¶ˆæ¯ï¼Œç›®æ ‡: ${targetCount}`)
                
                // å¦‚æœå·²ç»å®Œæˆæˆ–æ²¡æœ‰ä¸‹ä¸€é¡µæ ‡è¯†ï¼Œé€€å‡ºå¾ªç¯
                if (result.isCompleted || !result.nextReqMessageID) {
                    console.log(LOG_PRIFIX, `æ¶ˆæ¯è·å–å®Œæˆ: ${conversationID}`)
                    break
                }
                
                // è®¾ç½®ä¸‹ä¸€é¡µæ ‡è¯†
                nextReqMessageID = result.nextReqMessageID
            } catch (error) {
                retryCount++
                console.warn(LOG_PRIFIX, `è·å–æ¶ˆæ¯å¤±è´¥ï¼Œé‡è¯•ç¬¬ ${retryCount} æ¬¡: ${conversationID}`, error)
                
                // å¦‚æœè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸
                if (retryCount >= maxRetries) {
                    console.error(LOG_PRIFIX, `è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ${maxRetries}ï¼Œåœæ­¢é‡è¯•: ${conversationID}`)
                    throw new IMError('è·å–æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…é™', 'MAX_RETRIES_EXCEEDED', {
                        conversationID,
                        retryCount,
                        maxRetries,
                        error,
                    })
                }
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 1000 * retryCount))
            }
        }
        
        console.log(LOG_PRIFIX, `æœ€ç»ˆè·å–åˆ° ${allMessages.length} æ¡æ¶ˆæ¯: ${conversationID}`)
        return allMessages
    } catch (error) {
        console.error(LOG_PRIFIX, `è·å–æœ€è¿‘æ¶ˆæ¯å¤±è´¥: ${conversationID}`, error)
        throw new IMError('è·å–æœ€è¿‘æ¶ˆæ¯å¤±è´¥', 'GET_RECENT_MESSAGES_FAILED', error)
    }
}
```

### **6. çŠ¶æ€ç›‘æ§ç³»ç»Ÿ**

#### **å¥åº·æ£€æŸ¥æœºåˆ¶**
```typescript
// å¯åŠ¨å¥åº·æ£€æŸ¥
private startHealthCheck(): void {
    // å¿ƒè·³æ£€æŸ¥ - æ¯30ç§’
    this.heartbeatInterval = setInterval(() => {
        this.performHeartbeat()
    }, 30000)
    
    // å¥åº·çŠ¶æ€æ£€æŸ¥ - æ¯60ç§’
    this.healthCheckInterval = setInterval(() => {
        this.performHealthCheck()
    }, 60000)
    
    // é”™è¯¯è®¡æ•°é‡ç½® - æ¯åˆ†é’Ÿ
    setInterval(() => {
        this.errorCount = 0
    }, this.errorWindow)
}

// æ‰§è¡Œå¿ƒè·³æ£€æŸ¥
private performHeartbeat(): void {
    const now = Date.now()
    this.lastHeartbeat = now
    
    // æ›´æ–°çŠ¶æ€
    this.updateState({
        lastHeartbeat: now,
    })
    
    // æ£€æŸ¥è¿æ¥çŠ¶æ€
    if (this.connectionState !== ConnectionState.CONNECTED) {
        console.warn(LOG_PRIFIX, 'å¿ƒè·³æ£€æŸ¥ï¼šè¿æ¥çŠ¶æ€å¼‚å¸¸', this.connectionState)
    }
    
    // è§¦å‘å¿ƒè·³äº‹ä»¶
    this.emitter.emit(IMEventType.HEARTBEAT, {
        timestamp: now,
        connectionState: this.connectionState,
        networkState: this.networkState,
    })
}

// æ‰§è¡Œå¥åº·æ£€æŸ¥
private performHealthCheck(): void {
    const healthStatus = {
        connectionState: this.connectionState,
        networkState: this.networkState,
        isReady: this.ready,
        isLoggedIn: this.isUserLoggedIn,
        errorCount: this.errorCount,
        reconnectAttempts: this.reconnectAttempts,
        lastHeartbeat: this.lastHeartbeat,
        timestamp: Date.now(),
    }
    
    console.log(LOG_PRIFIX, 'å¥åº·æ£€æŸ¥çŠ¶æ€:', healthStatus)
    
    // è§¦å‘å¥åº·æ£€æŸ¥äº‹ä»¶
    this.emitter.emit(IMEventType.HEALTH_CHECK, healthStatus)
    
    // å¦‚æœçŠ¶æ€å¼‚å¸¸ï¼Œè§¦å‘è­¦å‘Š
    if (this.connectionState === ConnectionState.ERROR || this.errorCount > this.maxErrorCount / 2) {
        this.emitter.emit(IMEventType.HEALTH_WARNING, healthStatus)
    }
}
```

#### **ç½‘ç»œçŠ¶æ€ç›‘æ§**
```typescript
private handleNetworkStateChanged(event: any): void {
    const { state } = event.data
    const previousState = this.networkState
    const previousConnectionState = this.connectionState
    
    // ä½¿ç”¨è…¾è®¯äº‘IMçš„ç½‘ç»œçŠ¶æ€å¸¸é‡
    switch (state) {
        case TencentCloudChat.TYPES.NET_STATE_CONNECTED:
            this.networkState = NetworkState.WIFI
            this.connectionState = ConnectionState.CONNECTED
            this.reconnectAttempts = 0
            this.errorCount = 0
            console.log(LOG_PRIFIX, 'IM ç½‘ç»œå·²è¿æ¥')
            break
        case TencentCloudChat.TYPES.NET_STATE_CONNECTING:
            this.networkState = NetworkState.MOBILE
            this.connectionState = ConnectionState.CONNECTING
            console.log(LOG_PRIFIX, 'IM ç½‘ç»œæ­£åœ¨è¿æ¥...')
            break
        case TencentCloudChat.TYPES.NET_STATE_DISCONNECTED:
            this.networkState = NetworkState.NONE
            this.connectionState = ConnectionState.DISCONNECTED
            console.warn(LOG_PRIFIX, 'IM ç½‘ç»œå·²æ–­å¼€')
            this.handleDisconnection()
            break
        default:
            this.networkState = NetworkState.UNKNOWN
            this.connectionState = ConnectionState.ERROR
            console.error(LOG_PRIFIX, 'IM ç½‘ç»œçŠ¶æ€å¼‚å¸¸:', state)
    }
    
    // æ›´æ–°çŠ¶æ€
    this.updateState({
        networkState: this.networkState,
        connectionState: this.connectionState,
        reconnectAttempts: this.reconnectAttempts,
        errorCount: this.errorCount,
    })
    
    // è§¦å‘ç½‘ç»œçŠ¶æ€å˜åŒ–äº‹ä»¶
    this.emitter.emit(IMEventType.NETWORK_STATE_CHANGED, {
        previousState,
        currentState: this.networkState,
    })
    
    // è§¦å‘è¿æ¥çŠ¶æ€å˜åŒ–äº‹ä»¶
    this.emitter.emit(IMEventType.CONNECTION_STATE_CHANGED, {
        previousState: previousConnectionState,
        currentState: this.connectionState,
        reconnectAttempts: this.reconnectAttempts,
    })
}
```

### **7. ç¾¤ç»„æƒé™ç®¡ç†**

#### **è¸¢å‡ºç¾¤ç»„æˆå‘˜ - æƒé™æ§åˆ¶**
```typescript
public async kickGroupMember(
    groupID: string,
    memberIDList: string[],
    operatorID?: string,
): Promise<KickMemberResult> {
    try {
        this.validateGroupID(groupID)
        this.confirmReady()
        
        // å¦‚æœæ²¡æœ‰æŒ‡å®šæ“ä½œè€…ï¼Œä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·
        const currentOperatorID = operatorID || this.getCurrentUserID()
        if (!currentOperatorID) {
            return {
                success: false,
                message: 'æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·ID',
                errorCode: 10001,
            }
        }
        
        // æ£€æŸ¥æƒé™
        const hasPermission = await this.checkAdminPermission(groupID, currentOperatorID)
        if (!hasPermission) {
            return {
                success: false,
                message: 'æƒé™ä¸è¶³ï¼Œåªæœ‰ç¾¤ä¸»å’Œç®¡ç†å‘˜å¯ä»¥è¸¢äºº',
                errorCode: 10002,
                details: {
                    operatorID: currentOperatorID,
                    groupID,
                    requiredRoles: [GroupRole.OWNER, GroupRole.ADMIN],
                },
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å°è¯•è¸¢å‡ºç¾¤ä¸»
        const groupInfo = await this.getGroupInfo(groupID)
        const isKickingOwner = memberIDList.includes(groupInfo.ownerID)
        if (isKickingOwner) {
            return {
                success: false,
                message: 'ä¸èƒ½è¸¢å‡ºç¾¤ä¸»',
                errorCode: 10003,
                details: { ownerID: groupInfo.ownerID },
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å°è¯•è¸¢å‡ºç®¡ç†å‘˜ï¼ˆåªæœ‰ç¾¤ä¸»å¯ä»¥è¸¢å‡ºç®¡ç†å‘˜ï¼‰
        const operatorRole = await this.getGroupMemberRole(groupID, currentOperatorID)
        if (operatorRole !== GroupRole.OWNER) {
            // æ£€æŸ¥è¦è¸¢å‡ºçš„ç”¨æˆ·ä¸­æ˜¯å¦æœ‰ç®¡ç†å‘˜
            const membersToKick = await Promise.all(memberIDList.map(userID => this.getGroupMemberRole(groupID, userID)))
            const hasAdminInList = membersToKick.some(role => role === GroupRole.ADMIN)
            if (hasAdminInList) {
                return {
                    success: false,
                    message: 'åªæœ‰ç¾¤ä¸»å¯ä»¥è¸¢å‡ºç®¡ç†å‘˜',
                    errorCode: 10004,
                    details: { operatorRole, targetRoles: membersToKick },
                }
            }
        }
        
        // æ‰§è¡Œè¸¢äººæ“ä½œ
        const result = await this.chat.deleteGroupMember({
            groupID,
            userIDList: memberIDList,
            reason: 'è¢«ç®¡ç†å‘˜è¸¢å‡ºç¾¤ç»„',
        })
        
        console.log(LOG_PRIFIX, `è¸¢å‡ºç¾¤ç»„æˆå‘˜æˆåŠŸ: ${groupID}`, {
            operatorID: currentOperatorID,
            memberIDList,
            result,
        })
        
        return {
            success: true,
            message: `æˆåŠŸè¸¢å‡º ${memberIDList.length} åæˆå‘˜`,
            details: result,
        }
    } catch (error) {
        // é”™è¯¯å¤„ç†...
        return {
            success: false,
            message: 'è¸¢å‡ºç¾¤ç»„æˆå‘˜å¤±è´¥',
            errorCode: 10000,
            details: error,
        }
    }
}
```

### **8. Vue Composable é›†æˆ**

#### **useIMManager - Vueé›†æˆ**
```typescript
export function useIMManager(userID?: string, userSig?: string) {
    const imManager = IMManager.getInstance()
    const state = ref<IMState>(imManager.getState())
    
    try {
        // æ¸…ç†æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        imManager.offAllListeners()
        
        // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å¬
        imManager.onStateChange((newState: IMState) => {
            state.value = newState
        })
        
        // ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
        onMounted(async () => {
            try {
                // å…ˆç™»å‡º
                if (imManager.getLoginState()) {
                    await imManager.logout()
                }
                
                // å¦‚æœæœ‰ userID å’Œ userSigï¼Œåˆ™ç™»å½•
                if (userID && userSig) {
                    await imManager.login(userID, userSig)
                }
            } catch (error) {
                console.error(LOG_PRIFIX, 'IM åˆå§‹åŒ–å¤±è´¥:', error)
                throw new IMError('IM åˆå§‹åŒ–å¤±è´¥', 'INIT_FAILED', error)
            }
        })
        
        // ç»„ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº
        onUnmounted(() => {
            imManager.offAllListeners()
        })
    } catch (error) {
        console.error(LOG_PRIFIX, 'useIMManager åˆå§‹åŒ–å¤±è´¥:', error)
        throw error
    }
    
    return {
        imManager,
        state: readonly(state),
        // ä¾¿æ·çš„çŠ¶æ€è®¿é—®æ–¹æ³•
        isReady: computed(() => state.value.isReady),
        isLoggedIn: computed(() => state.value.isLoggedIn),
        connectionState: computed(() => state.value.connectionState),
        networkState: computed(() => state.value.networkState),
        errorCount: computed(() => state.value.errorCount),
        reconnectAttempts: computed(() => state.value.reconnectAttempts),
    }
}
```

## ğŸ¯ **æ ¸å¿ƒè®¾è®¡æ¨¡å¼**

### **1. å•ä¾‹æ¨¡å¼**
- ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªIMå®ä¾‹
- é¿å…é‡å¤åˆå§‹åŒ–å’Œèµ„æºæµªè´¹

### **2. è§‚å¯Ÿè€…æ¨¡å¼**
- ä½¿ç”¨EventEmitterè¿›è¡Œäº‹ä»¶é€šä¿¡
- çŠ¶æ€å˜åŒ–è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰ç›‘å¬è€…

### **3. ç­–ç•¥æ¨¡å¼**
- ä¸åŒé”™è¯¯ç é‡‡ç”¨ä¸åŒå¤„ç†ç­–ç•¥
- ç½‘ç»œçŠ¶æ€å˜åŒ–é‡‡ç”¨ä¸åŒé‡è¿ç­–ç•¥

### **4. ä»£ç†æ¨¡å¼**
- å°è£…è…¾è®¯äº‘IM SDKçš„å¤æ‚API
- æä¾›æ›´ç®€å•æ˜“ç”¨çš„æ¥å£

## ğŸš€ **ä½¿ç”¨ç¤ºä¾‹**

```typescript
// åœ¨Vueç»„ä»¶ä¸­ä½¿ç”¨
const { imManager, isReady, isLoggedIn, connectionState } = useIMManager(userID, userSig)

// ç›‘å¬äº‹ä»¶
imManager.on(IMEventType.CHAT_MSG, (message) => {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', message)
})

// å‘é€æ¶ˆæ¯
await imManager.sendGroupTextMessage('group123', 'Hello World!')

// åŠ å…¥ç¾¤ç»„
await imManager.joinGroup('group123')
```

è¿™ä¸ªIMç®¡ç†å™¨æä¾›äº†å®Œæ•´çš„å³æ—¶é€šè®¯åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€ç¾¤ç»„ç®¡ç†ã€æ¶ˆæ¯æ”¶å‘ã€çŠ¶æ€ç›‘æ§ç­‰ï¼Œæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„IMè§£å†³æ–¹æ¡ˆï¼ğŸ‰