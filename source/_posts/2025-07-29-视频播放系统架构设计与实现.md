---
title: è§†é¢‘æ’­æ”¾ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸å®ç°
author: é«˜çº¢ç¿”
date: 2025-07-29 10:25:59
categories: æ¶æ„
tags: å·¥å…·
---

> æœ¬æ–‡ä»‹ç»äº†ä¸€ä¸ªåŸºäº Vue 3 + TypeScript çš„è§†é¢‘æ’­æ”¾ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿé‡‡ç”¨äº†ä»£ç†æ¨¡å¼ã€äº‹ä»¶é©±åŠ¨æ¶æ„å’ŒçŠ¶æ€ç®¡ç†ï¼Œå®ç°äº†è·¨å¹³å°çš„è§†é¢‘æ’­æ”¾æ§åˆ¶ã€‚ç³»ç»Ÿä¸»è¦åº”ç”¨äºå†™ä½œæ•™å­¦åœºæ™¯ï¼Œæ”¯æŒæ•™å¸ˆè®²è§£è§†é¢‘çš„æ’­æ”¾ã€è¿›åº¦åŒæ­¥ã€æ—¶é—´è½´äº‹ä»¶è§¦å‘ç­‰åŠŸèƒ½ã€‚

## ç³»ç»Ÿæ¶æ„

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TeacherWindow â”‚    â”‚   VideoPlayer   â”‚    â”‚   VideoProxy    â”‚
â”‚   (UI ç»„ä»¶)     â”‚â—„â”€â”€â–ºâ”‚   (æ’­æ”¾å™¨ç»„ä»¶)   â”‚â—„â”€â”€â–ºâ”‚   (ä»£ç†å±‚)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                       â”‚
                                â–¼                       â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   write.ts      â”‚    â”‚ TimelineEmitter â”‚
                       â”‚   (çŠ¶æ€ç®¡ç†)     â”‚    â”‚   (æ—¶é—´è½´ç®¡ç†)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒç»„ä»¶å…³ç³»

- **TeacherWindow.vue**: UI å±•ç¤ºå±‚ï¼ŒåŒ…å«è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
- **VideoPlayer.vue**: è·¨å¹³å°è§†é¢‘æ’­æ”¾å™¨ï¼Œæ”¯æŒ App å’Œ Web ç¯å¢ƒ
- **VideoProxy.ts**: è§†é¢‘ä»£ç†å±‚ï¼Œç»Ÿä¸€ç®¡ç†æ’­æ”¾çŠ¶æ€å’Œäº‹ä»¶
- **write.ts**: ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå¤„ç†è§†é¢‘æ’­æ”¾çš„ä¸šåŠ¡é€»è¾‘

## `VideoProxy.ts`

> è¿™æ˜¯ä¸€ä¸ªè§†é¢‘ä»£ç†ç±»ï¼Œé‡‡ç”¨äº†ä»£ç†æ¨¡å¼è®¾è®¡ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†è§†é¢‘æ’­æ”¾å™¨çš„çŠ¶æ€å’Œè¡Œä¸ºï¼Œæä¾›äº‹ä»¶é©±åŠ¨çš„è§†é¢‘æ§åˆ¶æ¥å£ã€‚

### 1. å¯¼å…¥å’Œç±»å‹å®šä¹‰

```typescript
import { EventEmitter } from "eventemitter3"
import WriteUtilsVideoPlayer from "@/components/write/Utils/VideoPlayer.vue"
import { $pick } from "@/utils/global-properties"

// å®šä¹‰è§†é¢‘ä»£ç†æ”¯æŒçš„äº‹ä»¶ç±»å‹
type VideoProxyEvents = {
  ready: () => void // è§†é¢‘å‡†å¤‡å°±ç»ªäº‹ä»¶
  end: () => void // è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
  error: () => void // è§†é¢‘æ’­æ”¾é”™è¯¯äº‹ä»¶
  meta: (duration: number) => void // è§†é¢‘å…ƒæ•°æ®äº‹ä»¶ï¼ˆè·å–æ—¶é•¿ï¼‰
  tick: (time: number, duration?: number) => void // è§†é¢‘æ’­æ”¾è¿›åº¦äº‹ä»¶
}
```

### 2. VideoProxy ç±»ç»“æ„

```typescript
export class VideoProxy extends EventEmitter<VideoProxyEvents> {
	private videoRef: InstanceType<typeof WriteUtilsVideoPlayer> | null = null  // è§†é¢‘ç»„ä»¶å¼•ç”¨
	private isActive: boolean = false    // æ˜¯å¦æ¿€æ´»çŠ¶æ€
	private isReady: boolean = false     // æ˜¯å¦å‡†å¤‡å°±ç»ª
```

### 3. æ„é€ å‡½æ•°

```typescript
constructor() {
	super()
	this.on('ready', () => {
		this.isReady = true
		this.play()  // å‡†å¤‡å°±ç»ªåè‡ªåŠ¨æ’­æ”¾
	})
}
```

### 4. æ ¸å¿ƒæ–¹æ³•è§£æ

#### **takeOver() - æ¥ç®¡è§†é¢‘ç»„ä»¶**

```typescript
takeOver(videoRef: InstanceType<typeof WriteUtilsVideoPlayer>) {
	this.videoRef = videoRef
	this.videoRef.setBus(this)  // è®¾ç½®äº‹ä»¶æ€»çº¿
}
```

**ä½œç”¨**:

- æ¥æ”¶ä¸€ä¸ªè§†é¢‘ç»„ä»¶å®ä¾‹
- å»ºç«‹ä»£ç†ä¸è§†é¢‘ç»„ä»¶çš„è¿æ¥
- è®¾ç½®äº‹ä»¶é€šä¿¡æœºåˆ¶

#### **active å±æ€§è®¾ç½®å™¨**

```typescript
set active(isActive: boolean) {
	if (!isActive) {
		this.off('end')    // å–æ¶ˆæ¿€æ´»æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
		this.off('tick')
	}
	if (this.videoRef) {
		this.isActive = isActive
		this.videoRef.setActive(isActive)  // é€šçŸ¥è§†é¢‘ç»„ä»¶æ¿€æ´»çŠ¶æ€
		this.play()  // æ¿€æ´»æ—¶è‡ªåŠ¨æ’­æ”¾
	}
}
```

**ä½œç”¨**:

- æ§åˆ¶ä»£ç†çš„æ¿€æ´»çŠ¶æ€
- çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨ç®¡ç†äº‹ä»¶ç›‘å¬
- æ¿€æ´»æ—¶è‡ªåŠ¨å¼€å§‹æ’­æ”¾

#### **æ’­æ”¾æ§åˆ¶æ–¹æ³•**

```typescript
// æ’­æ”¾è§†é¢‘
play() {
	if (this.videoRef && this.isActive && this.isReady) {
		this.videoRef.play()  // åªæœ‰åœ¨æ¿€æ´»ä¸”å‡†å¤‡å°±ç»ªæ—¶æ‰æ’­æ”¾
	}
}

// æš‚åœæ’­æ”¾
pause() {
	if (this.videoRef) {
		this.videoRef.pause()
	}
}

// æ¢å¤æ’­æ”¾
resume() {
	if (this.videoRef) {
		this.videoRef.resume()
	}
}

// è·³è½¬åˆ°æŒ‡å®šæ—¶é—´
seek(time: number) {
	if (this.videoRef) {
		this.videoRef.seek(time)
	}
}
```

### 5. è®¾è®¡æ¨¡å¼åˆ†æ

#### **ä»£ç†æ¨¡å¼ (Proxy Pattern)**

```typescript
// VideoProxy ä½œä¸ºè§†é¢‘ç»„ä»¶çš„ä»£ç†
// å°è£…äº†è§†é¢‘æ’­æ”¾çš„å¤æ‚é€»è¾‘
// æä¾›äº†ç»Ÿä¸€çš„æ¥å£æ¥æ§åˆ¶è§†é¢‘æ’­æ”¾
```

**ä»£ç†æ¨¡å¼çš„ä¼˜åŠ¿**:

- âœ… å°è£…äº†è§†é¢‘æ’­æ”¾çš„å¤æ‚é€»è¾‘
- âœ… æä¾›äº†ç»Ÿä¸€çš„æ§åˆ¶æ¥å£
- âœ… å¯ä»¥æ·»åŠ é¢å¤–çš„æ§åˆ¶é€»è¾‘ï¼ˆå¦‚çŠ¶æ€æ£€æŸ¥ï¼‰
- âœ… å®ç°äº†ç»„ä»¶é—´çš„è§£è€¦

#### **äº‹ä»¶é©±åŠ¨æ¶æ„**

```typescript
// ç»§æ‰¿è‡ª EventEmitterï¼Œæ”¯æŒäº‹ä»¶æœºåˆ¶
// é€šè¿‡äº‹ä»¶ä¸è§†é¢‘ç»„ä»¶é€šä¿¡
// æ”¯æŒå¤šç§äº‹ä»¶ç±»å‹
```

**äº‹ä»¶ç±»å‹è¯´æ˜**:

- `ready`: è§†é¢‘å‡†å¤‡å°±ç»ª
- `end`: è§†é¢‘æ’­æ”¾ç»“æŸ
- `error`: è§†é¢‘æ’­æ”¾é”™è¯¯
- `meta`: è·å–è§†é¢‘å…ƒæ•°æ®
- `tick`: æ’­æ”¾è¿›åº¦æ›´æ–°

#### **çŠ¶æ€ç®¡ç†**

```typescript
private isActive: boolean = false    // æ§åˆ¶ä»£ç†æ˜¯å¦æ¿€æ´»
private isReady: boolean = false     // æ§åˆ¶è§†é¢‘æ˜¯å¦å‡†å¤‡å°±ç»ª
```

**çŠ¶æ€é€»è¾‘**:

- åªæœ‰åŒæ—¶æ»¡è¶³ `isActive` å’Œ `isReady` æ—¶æ‰èƒ½æ’­æ”¾
- çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ç›¸åº”è¡Œä¸º

### 6. ä½¿ç”¨æµç¨‹

```typescript
// 1. åˆ›å»ºä»£ç†å®ä¾‹
const videoProxy = new VideoProxy()

// 2. æ¥ç®¡è§†é¢‘ç»„ä»¶
videoProxy.takeOver(videoComponent)

// 3. æ¿€æ´»ä»£ç†
videoProxy.active = true

// 4. ç›‘å¬äº‹ä»¶
videoProxy.on("tick", (time) => {
  console.log("æ’­æ”¾è¿›åº¦:", time)
})

// 5. æ§åˆ¶æ’­æ”¾
videoProxy.play()
videoProxy.pause()
videoProxy.seek(30)
```

### 7. åœ¨ write.ts ä¸­çš„ä½¿ç”¨

```typescript
// åˆ›å»ºè§†é¢‘ä»£ç†å®ä¾‹
const videoTeacherProxy: VideoProxy = new VideoProxy()
const videoSceneFrameProxy: VideoProxy = new VideoProxy()

// ç›‘å¬æ’­æ”¾è¿›åº¦äº‹ä»¶
videoTeacherProxy.on("tick", (time) => {
  __updateTimelineEmitters(time) // æ›´æ–°æ—¶é—´è½´å‘å°„å™¨
})

// ç›‘å¬æ’­æ”¾ç»“æŸäº‹ä»¶
videoTeacherProxy.on("end", () => {
  __handleCleanForVideo() // æ¸…ç†è§†é¢‘ç›¸å…³çŠ¶æ€
  resolve()
})
```

### 8. ä¼˜ç‚¹æ€»ç»“

- âœ… **å°è£…æ€§**: å°è£…äº†è§†é¢‘æ’­æ”¾çš„å¤æ‚é€»è¾‘
- âœ… **ç»Ÿä¸€æ¥å£**: æä¾›äº†ç»Ÿä¸€çš„æ’­æ”¾æ§åˆ¶æ¥å£
- âœ… **äº‹ä»¶é©±åŠ¨**: æ”¯æŒäº‹ä»¶æœºåˆ¶ï¼Œæ˜“äºæ‰©å±•
- âœ… **çŠ¶æ€ç®¡ç†**: æ¸…æ™°çš„çŠ¶æ€ç®¡ç†é€»è¾‘
- âœ… **è§£è€¦è®¾è®¡**: å®ç°äº†ç»„ä»¶é—´çš„è§£è€¦
- âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨ TypeScript æä¾›ç±»å‹å®‰å…¨

### 9. åº”ç”¨åœºæ™¯

è¿™ä¸ªä»£ç†ç±»ä¸»è¦ç”¨äºï¼š

1. **å†™ä½œæ¨¡å—çš„è§†é¢‘æ’­æ”¾æ§åˆ¶**
2. **ç»Ÿä¸€ç®¡ç†å¤šä¸ªè§†é¢‘ç»„ä»¶**
3. **æä¾›äº‹ä»¶é©±åŠ¨çš„è§†é¢‘æ§åˆ¶æ¥å£**
4. **ç¡®ä¿è§†é¢‘æ’­æ”¾çš„çŠ¶æ€ä¸€è‡´æ€§**

è¿™æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„è§†é¢‘ä»£ç†ç±»ï¼Œå¾ˆå¥½åœ°ä½“ç°äº†ä»£ç†æ¨¡å¼å’Œäº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ€æƒ³ï¼Œä¸ºè§†é¢‘æ’­æ”¾æä¾›äº†ç»Ÿä¸€ã€å¯é çš„æ¥å£ã€‚

### æºç ï¼š

```ts
import { EventEmitter } from "eventemitter3"
import WriteUtilsVideoPlayer from "@/components/write/Utils/VideoPlayer.vue"
import { $pick } from "@/utils/global-properties"

type VideoProxyEvents = {
  ready: () => void
  end: () => void
  error: () => void
  meta: (duration: number) => void
  tick: (time: number, duration?: number) => void
}

export class VideoProxy extends EventEmitter<VideoProxyEvents> {
  private videoRef: InstanceType<typeof WriteUtilsVideoPlayer> | null = null
  private isActive: boolean = false
  private isReady: boolean = false
  constructor() {
    super()
    this.on("ready", () => {
      this.isReady = true
      this.play()
    })
  }

  takeOver(videoRef: InstanceType<typeof WriteUtilsVideoPlayer>) {
    this.videoRef = videoRef
    this.videoRef.setBus(this)
  }
  set active(isActive: boolean) {
    if (!isActive) {
      this.off("end")
      this.off("tick")
    }
    if (this.videoRef) {
      this.isActive = isActive
      this.videoRef.setActive(isActive)
      this.play()
    }
  }
  play() {
    if (this.videoRef && this.isActive && this.isReady) {
      this.videoRef.play()
    }
  }
  pause() {
    if (this.videoRef) {
      this.videoRef.pause()
    }
  }
  resume() {
    if (this.videoRef) {
      this.videoRef.resume()
    }
  }
  seek(time: number) {
    if (this.videoRef) {
      this.videoRef.seek(time)
    }
  }
}
```

## `VideoPlayer.vue`

> è¿™æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼Œæ”¯æŒ App åŸç”Ÿæ’­æ”¾å’Œ Web æµè§ˆå™¨æ’­æ”¾ä¸¤ç§æ¨¡å¼ã€‚

### 1. æ¨¡æ¿ç»“æ„

```vue
<template>
  <!-- Web ç¯å¢ƒï¼šä½¿ç”¨ HTML5 video å…ƒç´  -->
  <video
    v-if="!isApp && active"
    preload="auto"
    webkit-playsinline
    ref="videoRef"
    :src="src"
    playbackRate="1"
    @canplay="handleCanPlay"
    :autoplay="autoplay"
    :muted="muted"
    @ended="handleVideoEnd"
    @error="handleError"
    @timeupdate="handleTimeUpdate"
    @loadedmetadata="handleLoadedMetadata"
    :style="{...}"
    class="video-player"
  ></video>

  <!-- App ç¯å¢ƒï¼šä½¿ç”¨åŸç”Ÿå®¹å™¨ -->
  <div v-else-if="active" class="video-player" ref="videoRef"></div>
</template>
```

### 2. æ ¸å¿ƒçŠ¶æ€ç®¡ç†

```typescript
const isApp = ref(browserInfo().isApp) // åˆ¤æ–­æ˜¯å¦ä¸º App ç¯å¢ƒ
const videoRef = ref<HTMLVideoElement | null>(null) // è§†é¢‘å…ƒç´ å¼•ç”¨
const bus = ref<VideoProxy>() // äº‹ä»¶æ€»çº¿ï¼ˆVideoProxy å®ä¾‹ï¼‰
const active = ref(false) // æ˜¯å¦æ¿€æ´»çŠ¶æ€
const playerId = ref("") // æ’­æ”¾å™¨å”¯ä¸€æ ‡è¯†
```

### 3. Props é…ç½®

```typescript
const props = defineProps({
  src: { type: String, default: "" }, // è§†é¢‘æºåœ°å€
  duration: { type: Number, default: 0 }, // è§†é¢‘æ—¶é•¿
  autoplay: { type: Boolean, default: false }, // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
  muted: { type: Boolean, default: false }, // æ˜¯å¦é™éŸ³
  fitMode: { type: String, default: "W" }, // é€‚é…æ¨¡å¼ï¼šH-é«˜å®½æ¯”ï¼ŒW-å®½åº¦
  scale: { type: Number, default: 1 }, // ç¼©æ”¾æ¯”ä¾‹
  zIndex: { type: Number, default: 0 }, // å±‚çº§
})
```

### 4. æ ¸å¿ƒæ–¹æ³•è§£æ

#### **App ç¯å¢ƒç›¸å…³æ–¹æ³•**

```typescript
// æ˜¾ç¤ºåŸç”Ÿè§†é¢‘è§†å›¾
async function showNativeVideo() {
  const rect = videoRef.value?.getBoundingClientRect()
  if (!rect) return
  let { left, right, top, bottom, width, height } = rect
  await $bridge.showLiveVideoView({
    centerX: ((right + left) / 2 / window.innerWidth).toString(),
    centerY: ((bottom + top) / 2 / window.innerHeight).toString(),
    width: (width / window.innerWidth).toString(),
    height: (height / window.innerHeight).toString(),
    cornerRadius: "12",
    zIndex: "1",
    playerId: playerId.value,
    renderMode: "0",
  })
}

// ç§»é™¤åŸç”Ÿè§†é¢‘è§†å›¾
function removeNativeVideo() {
  $bridge.removeVideoPlayerView({
    playerId: playerId.value,
  })
}
```

#### **çŠ¶æ€æ§åˆ¶æ–¹æ³•**

```typescript
// è®¾ç½®æ¿€æ´»çŠ¶æ€
const setActive = async (val: boolean) => {
  active.value = val
  await nextTick()
  if (isApp.value) {
    if (!val) {
      removeNativeVideo() // å–æ¶ˆæ¿€æ´»æ—¶ç§»é™¤åŸç”Ÿè§†å›¾
    } else {
      showNativeVideo() // æ¿€æ´»æ—¶æ˜¾ç¤ºåŸç”Ÿè§†å›¾
      bus.value?.emit("ready") // å‘é€å‡†å¤‡å°±ç»ªäº‹ä»¶
    }
  }
}

// è®¾ç½®äº‹ä»¶æ€»çº¿
const setBus = (_bus: VideoProxy) => {
  bus.value = _bus
}
```

#### **æ’­æ”¾æ§åˆ¶æ–¹æ³•**

```typescript
// æ’­æ”¾è§†é¢‘
const play = () => {
  if (isApp.value) {
    // App ç¯å¢ƒï¼šè°ƒç”¨åŸç”Ÿæ’­æ”¾æ¥å£
    $bridge.playLiveVideo({
      playUrl: props.src,
      onTick: (time: number) => {
        isTeacherSpeaking.value = true
        bus.value?.emit("tick", time / 1000, 51) // å‘é€æ’­æ”¾è¿›åº¦äº‹ä»¶
      },
      onStatus: (status: string) => {
        if (status == "4") {
          isTeacherSpeaking.value = false
          bus.value?.emit("end") // å‘é€æ’­æ”¾ç»“æŸäº‹ä»¶
        }
      },
      playerId: playerId.value,
    })
  } else {
    // Web ç¯å¢ƒï¼šè°ƒç”¨ HTML5 video æ’­æ”¾
    videoRef.value?.play()
  }
}

// æš‚åœæ’­æ”¾
const pause = () => {
  if (isApp.value) {
    $bridge.pauseLiveVideo({ playerId: playerId.value })
  } else {
    videoRef.value?.pause()
  }
}

// æ¢å¤æ’­æ”¾
const resume = () => {
  if (isApp.value) {
    $bridge.resumeLiveVideo({ playerId: playerId.value })
  } else {
    videoRef.value?.play()
  }
}

// è·³è½¬åˆ°æŒ‡å®šæ—¶é—´
const seek = (time: number) => {
  if (isApp.value) {
    $bridge.seekLiveVideoTo({
      playerId: playerId.value,
      seekTime: time.toString(),
    })
  } else {
    if (videoRef.value) {
      videoRef.value.currentTime = time
    }
  }
}
```

#### **äº‹ä»¶å¤„ç†æ–¹æ³•**

```typescript
// è§†é¢‘å¯ä»¥æ’­æ”¾æ—¶
const handleCanPlay = () => {
  bus.value?.emit("ready")
}

// è§†é¢‘æ’­æ”¾ç»“æŸæ—¶
const handleVideoEnd = () => {
  isTeacherSpeaking.value = false
  bus.value?.emit("end")
}

// è§†é¢‘æ’­æ”¾é”™è¯¯æ—¶
const handleError = () => {
  bus.value?.emit("error")
}

// è§†é¢‘æ’­æ”¾è¿›åº¦æ›´æ–°æ—¶ï¼ˆWeb ç¯å¢ƒï¼‰
const handleTimeUpdate = () => {
  isTeacherSpeaking.value = true
  bus.value?.emit(
    "tick",
    videoRef.value?.currentTime || 0,
    videoRef.value?.duration
  )
}

// è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆæ—¶
const handleLoadedMetadata = () => {
  bus.value?.emit("meta", videoRef.value?.duration || 0)
}
```

### 5. è®¾è®¡æ¨¡å¼åˆ†æ

#### **é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)**

- ç»Ÿä¸€äº† App åŸç”Ÿæ’­æ”¾å’Œ Web HTML5 æ’­æ”¾çš„æ¥å£
- é€šè¿‡ `isApp` åˆ¤æ–­ä½¿ç”¨ä¸åŒçš„æ’­æ”¾å®ç°
- å¯¹å¤–æä¾›ç»Ÿä¸€çš„æ’­æ”¾æ§åˆ¶æ–¹æ³•

#### **äº‹ä»¶é©±åŠ¨æ¶æ„**

- é€šè¿‡ `bus` (VideoProxy) å‘é€äº‹ä»¶
- æ”¯æŒ `ready`ã€`end`ã€`error`ã€`tick`ã€`meta` ç­‰äº‹ä»¶
- å®ç°äº†ç»„ä»¶é—´çš„è§£è€¦

#### **çŠ¶æ€ç®¡ç†**

- `active`: æ§åˆ¶ç»„ä»¶æ˜¯å¦æ¿€æ´»
- `isTeacherSpeaking`: ç®¡ç†æ•™å¸ˆè¯´è¯çŠ¶æ€
- çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ç›¸åº”è¡Œä¸º

### 6. ä½¿ç”¨åœºæ™¯

è¿™ä¸ªç»„ä»¶ä¸»è¦ç”¨äºï¼š

1. **å†™ä½œæ¨¡å—çš„è§†é¢‘æ’­æ”¾**
2. **æ•™å¸ˆè®²è§£è§†é¢‘çš„æ’­æ”¾æ§åˆ¶**
3. **åœºæ™¯è§†é¢‘çš„æ’­æ”¾ç®¡ç†**
4. **è·¨å¹³å°è§†é¢‘æ’­æ”¾çš„ç»Ÿä¸€æ¥å£**

### 7. ä¼˜ç‚¹

- âœ… è·¨å¹³å°å…¼å®¹æ€§å¥½
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œæ˜“äºæ‰©å±•
- âœ… çŠ¶æ€ç®¡ç†æ¸…æ™°
- âœ… æ¥å£ç»Ÿä¸€ï¼Œä½¿ç”¨ç®€å•
- âœ… æ”¯æŒå¤šç§æ’­æ”¾æ§åˆ¶åŠŸèƒ½

è¿™æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼Œå¾ˆå¥½åœ°å¤„ç†äº†è·¨å¹³å°æ’­æ”¾çš„å¤æ‚æ€§ï¼Œå¹¶æä¾›äº†ç»Ÿä¸€çš„äº‹ä»¶æ¥å£ã€‚

### æºç 

```vue
<template>
  <video
    v-if="!isApp && active"
    preload="auto"
    webkit-playsinline
    ref="videoRef"
    :src="src"
    playbackRate="1"
    @canplay="handleCanPlay"
    :autoplay="autoplay"
    :muted="muted"
    @ended="handleVideoEnd"
    @error="handleError"
    @timeupdate="handleTimeUpdate"
    @loadedmetadata="handleLoadedMetadata"
    :style="{
      width: fitMode === 'W' ? `calc(100% * ${scale})` : 'auto',
      height: fitMode === 'H' ? `calc(100% * ${scale})` : 'auto',
      zIndex: zIndex,
    }"
    class="video-player"
  ></video>
  <div v-else-if="active" class="video-player" ref="videoRef"></div>
</template>

<script setup lang="ts">
import { v4 as uuidv4 } from "uuid"
import { nextTick, onBeforeMount, onMounted, ref, watch } from "vue"
import { $bridge, $pick } from "@/utils/global-properties"
import { VideoProxy } from "@/store/modules/write/VideoProxy"
import { browserInfo } from "@/utils/tool"
const isApp = ref(browserInfo().isApp)
const videoRef = ref<HTMLVideoElement | null>(null)
const bus = ref<VideoProxy>()

import { storeToRefs } from "pinia"
import { useWriteStore } from "@/store"
const writeStore = useWriteStore()
const { isTeacherSpeaking } = storeToRefs(writeStore)

const props = defineProps({
  src: {
    type: String,
    default: "",
  },
  duration: {
    type: Number,
    default: 0,
  },
  autoplay: {
    type: Boolean,
    default: false,
  },
  muted: {
    type: Boolean,
    default: false,
  },
  fitMode: {
    type: String,
    default: "W", //H:é«˜å®½æ¯”é€‚é…ï¼ŒW:å®½åº¦é€‚é…
  },
  scale: {
    type: Number,
    default: 1,
  },
  zIndex: {
    type: Number,
    default: 0,
  },
})
const active = ref(false)
const playerId = ref("")
onBeforeMount(() => {
  playerId.value = uuidv4()
})

async function showNativeVideo() {
  const rect = videoRef.value?.getBoundingClientRect()
  if (!rect) return
  let { left, right, top, bottom, width, height } = rect
  await $bridge.showLiveVideoView({
    centerX: ((right + left) / 2 / window.innerWidth).toString(),
    centerY: ((bottom + top) / 2 / window.innerHeight).toString(),
    width: (width / window.innerWidth).toString(),
    height: (height / window.innerHeight).toString(),
    cornerRadius: "12",
    zIndex: "1",
    playerId: playerId.value,
    renderMode: "0",
  })
}

function removeNativeVideo() {
  $bridge.removeVideoPlayerView({
    playerId: playerId.value,
  })
}

const setActive = async (val: boolean) => {
  active.value = val
  await nextTick()
  console.log("ğŸš€ ~ setActive ~ val:", val, props.src)
  if (isApp.value) {
    if (!val) {
      removeNativeVideo()
    } else {
      showNativeVideo()
      bus.value?.emit("ready")
    }
  }
}
const setBus = (_bus: VideoProxy) => {
  bus.value = _bus
}

const play = () => {
  console.log("DEBUG_LOG:play call ", props.src)
  if (isApp.value) {
    $bridge.playLiveVideo({
      playUrl: props.src,
      onTick: (time: number) => {
        isTeacherSpeaking.value = true
        bus.value?.emit("tick", time / 1000, 51)
      },
      onStatus: (status: string) => {
        if (status == "4") {
          isTeacherSpeaking.value = false
          bus.value?.emit("end")
        }
      },
      playerId: playerId.value,
    })
  } else {
    videoRef.value?.play()
  }
}
const pause = () => {
  if (isApp.value) {
    $bridge.pauseLiveVideo({
      playerId: playerId.value,
    })
  } else {
    videoRef.value?.pause()
  }
}
const resume = () => {
  if (isApp.value) {
    $bridge.resumeLiveVideo({
      playerId: playerId.value,
    })
  } else {
    videoRef.value?.play()
  }
}
const seek = (time: number) => {
  if (isApp.value) {
    $bridge.seekLiveVideoTo({
      playerId: playerId.value,
      seekTime: time.toString(),
    })
  } else {
    if (videoRef.value) {
      videoRef.value.currentTime = time
    }
  }
}
const handleCanPlay = () => {
  console.log("DEBUG_LOG:call can play ", props.src)
  bus.value?.emit("ready")
}
const handleVideoEnd = () => {
  isTeacherSpeaking.value = false
  bus.value?.emit("end")
}
const handleError = () => {
  bus.value?.emit("error")
}
const handleTimeUpdate = () => {
  isTeacherSpeaking.value = true
  bus.value?.emit(
    "tick",
    videoRef.value?.currentTime || 0,
    videoRef.value?.duration
  )
}
const handleLoadedMetadata = () => {
  bus.value?.emit("meta", videoRef.value?.duration || 0)
}

watch(
  () => props.src,
  (val) => {
    console.log("DEBUG_LOG:call video src change", val)
  }
)

defineExpose({
  play,
  pause,
  resume,
  seek,
  setActive,
  setBus,
})
</script>

<style scoped lang="scss">
.video-player {
  width: 100%;
  height: 100%;
  position: absolute;
}
</style>
```

## ä½¿ç”¨

### åœ¨`TeacherWindow.vue`ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<template>
  <WriteUtilsVideoPlayer src="xxx" :fitMode="'W'" ref="videoTeacherEnterRef" />
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue"

import { useWriteStore } from "@/store"
const writeStore = useWriteStore()
const { videoTeacherProxy } = writeStore

import WriteUtilsVideoPlayer from "@/components/write/Utils/VideoPlayer.vue"

const videoTeacherEnterRef = ref<InstanceType<
  typeof WriteUtilsVideoPlayer
> | null>(null)

onMounted(() => {
  if (videoTeacherEnterRef.value) {
    videoTeacherProxy.takeOver(videoTeacherEnterRef.value)
  }
})
</script>

<style lang="scss" scoped></style>
```

### åœ¨ write.ts ä¸­çš„ä½¿ç”¨

```ts
// åˆ›å»ºè§†é¢‘ä»£ç†å®ä¾‹
const videoTeacherProxy: VideoProxy = new VideoProxy()
// ç›‘å¬æ’­æ”¾è¿›åº¦äº‹ä»¶
videoTeacherProxy.on("tick", (time) => {
  __updateTimelineEmitters(time) // æ›´æ–°æ—¶é—´è½´å‘å°„å™¨
})

// ç›‘å¬æ’­æ”¾ç»“æŸäº‹ä»¶
videoTeacherProxy.on("end", () => {
  __handleCleanForVideo() // æ¸…ç†è§†é¢‘ç›¸å…³çŠ¶æ€
})
```

-

## æŠ€æœ¯äº®ç‚¹

### 1. è·¨å¹³å°å…¼å®¹æ€§

- ç»Ÿä¸€æ¥å£è®¾è®¡ï¼Œæ”¯æŒ App å’Œ Web ç¯å¢ƒ
- è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹ï¼Œé€‰æ‹©åˆé€‚çš„æ’­æ”¾æ–¹å¼
- äº‹ä»¶æœºåˆ¶ç»Ÿä¸€ï¼Œå±è”½å¹³å°å·®å¼‚

### 2. äº‹ä»¶é©±åŠ¨æ¶æ„

- æ¾è€¦åˆè®¾è®¡ï¼Œç»„ä»¶é—´é€šè¿‡äº‹ä»¶é€šä¿¡
- æ”¯æŒå¤šç§äº‹ä»¶ç±»å‹ï¼Œæ˜“äºæ‰©å±•
- æ—¶é—´è½´äº‹ä»¶ç³»ç»Ÿï¼Œç²¾ç¡®æ§åˆ¶æ’­æ”¾è¿›åº¦

### 3. çŠ¶æ€ç®¡ç†

- æ¸…æ™°çš„çŠ¶æ€å®šä¹‰å’Œç®¡ç†
- çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ç›¸åº”è¡Œä¸º
- é˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜

### 4. ä»£ç†æ¨¡å¼åº”ç”¨

- å°è£…å¤æ‚æ’­æ”¾é€»è¾‘
- æä¾›ç»Ÿä¸€æ§åˆ¶æ¥å£
- æ”¯æŒçŠ¶æ€æ£€æŸ¥å’Œäº‹ä»¶ç®¡ç†

## åº”ç”¨åœºæ™¯

### 1. å†™ä½œæ•™å­¦

- æ•™å¸ˆè®²è§£è§†é¢‘æ’­æ”¾
- è¿›åº¦åŒæ­¥å’Œæ—¶é—´è½´äº‹ä»¶
- ç„¦ç‚¹å’Œæ°”æ³¡æ˜¾ç¤º

### 2. äº¤äº’å¼æ•™å­¦

- è§†é¢‘æ’­æ”¾ä¸ç”¨æˆ·äº¤äº’ç»“åˆ
- å®æ—¶çŠ¶æ€åé¦ˆ
- å¤šç»„ä»¶åè°ƒå·¥ä½œ

## æ€»ç»“

è¿™ä¸ªè§†é¢‘æ’­æ”¾ç³»ç»Ÿé€šè¿‡ä»£ç†æ¨¡å¼ã€äº‹ä»¶é©±åŠ¨æ¶æ„å’ŒçŠ¶æ€ç®¡ç†ï¼Œå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ‰©å±•æ€§å¼ºçš„è·¨å¹³å°è§†é¢‘æ’­æ”¾è§£å†³æ–¹æ¡ˆã€‚ç³»ç»Ÿè®¾è®¡æ¸…æ™°ï¼Œä»£ç ç»“æ„è‰¯å¥½ï¼Œä¸ºå†™ä½œæ•™å­¦ç­‰åœºæ™¯æä¾›äº†å¯é çš„è§†é¢‘æ’­æ”¾æ”¯æŒã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:

- âœ… è·¨å¹³å°å…¼å®¹æ€§å¥½
- âœ… äº‹ä»¶é©±åŠ¨ï¼Œæ˜“äºæ‰©å±•
- âœ… çŠ¶æ€ç®¡ç†æ¸…æ™°
- âœ… æ¥å£ç»Ÿä¸€ï¼Œä½¿ç”¨ç®€å•
- âœ… æ”¯æŒå¤æ‚çš„æ—¶é—´è½´äº‹ä»¶

è¿™ä¸ªç³»ç»Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§†é¢‘æ’­æ”¾è§£å†³æ–¹æ¡ˆï¼Œå€¼å¾—åœ¨å…¶ä»–é¡¹ç›®ä¸­å‚è€ƒå’Œåº”ç”¨ã€‚
